@page
@model CS_Project_Manager.Pages.DiscussionPostModel
@{
    <div class="container">
        <!-- Main Post -->
        <div class="post">
            <h2>@Model.Post.Title</h2>
            <small>By: @await Model.GetAuthorNameAsync(Model.Post.PosterId)</small>
            <p>@Model.Post.Content</p>

            <!-- Reply Button -->
            <button type="button" class="btn btn-sm btn-primary reply-btn" data-post-id="@Model.Post.Id">Reply</button>

            <!-- Hidden Reply Form -->
            <form method="post" class="reply-form" id="reply-form-@Model.Post.Id" style="display: none;">
                @Html.AntiForgeryToken()  <!-- CSRF Protection -->
                <!-- Immediate Parent Post ID -->
                <input type="hidden" name="immediateParentPostId" value="@Model.Post.Id" />

                <!-- Head Post ID (Main Post) -->
                <input type="hidden" name="headPostId" value="@Model.Post.Id" />

                <textarea class="form-control reply-text" name="content" rows="3"></textarea>
                <button type="submit" class="btn btn-success submit-reply">Submit Reply</button>
            </form>

            <!-- Render Replies -->
            <div class="replies">
                @foreach (var reply in Model.Replies)
                {
                    @await Html.PartialAsync("Discussion/_ReplyPartial", new { Reply = reply, Model })
                }
            </div>
        </div>

        <hr />
    </div>

    <!-- jQuery for Reply Button and AJAX Submission -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $(".reply-btn").click(function () {
                var postId = $(this).data("post-id");
                $("#reply-form-" + postId).toggle();
            });

            $(".reply-form").submit(function (event) {
                event.preventDefault(); // Prevent full-page refresh

                var form = $(this);
                var formData = form.serialize(); // Serialize form data (includes CSRF token)

                $.post("/DiscussionPost?handler=PostReply", formData)
                    .done(function () {
                        location.reload(); // Reload to reflect the new reply
                    })
                    .fail(function (xhr) {
                        alert("Failed to post reply: " + xhr.responseText);
                    });
            });
        });

    </script>
}


