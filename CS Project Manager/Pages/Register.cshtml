@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<h2>Register a New Student</h2>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
    </div>
}

<form method="post">
    <div>
        <label>Email</label>
        <input asp-for="Email" type="email" maxlength="255" />
    </div>

    <div>
        <label>Password</label>
        <input asp-for="Password" type="password" required />
    </div>

    <div>
        <label>First Name</label>
        <input asp-for="FirstName" required maxlength="100" />
    </div>

    <div>
        <label>Last Name</label>
        <input asp-for="LastName" required maxlength="100" />
    </div>

    <div>
        <label>Enrolled Classes</label>
        <select id="enrolledClasses" name="EnrolledClasses" multiple="multiple" style="width: 100%;"></select>
    </div>

    <button type="submit">Register</button>
</form>

<!--import select2 functionality-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />

<script>
    $(document).ready(function () {
        // select2 cannot filter from ajax queries, item must have local data
        // perform queries and store results in these arrays
        let classData = [];
        let selectedClasses = [];

        // Fetch all classes initially and store them
        $.ajax({
            url: '/Register?handler=GetClasses',
            dataType: 'json',
            success: function (data) {
                // Convert fetched data into Select2-compatible format
                classData = data.map(item => ({ id: item.name, text: item.name }));
                initializeClassDropdown();
            }
        });

        // Initialize class dropdown
        function initializeClassDropdown() {
            $('#enrolledClasses').select2({
                tags: true,
                placeholder: "Select or add a class",
                data: classData,
                createTag: (params) => {
                    let term = $.trim(params.term);

                    // Prevent adding an empty or duplicate class
                    if (!term || classData.some(item => item.text.toLowerCase() === term.toLowerCase())) return null;
                    if (term.length > 100) return null;

                    return { id: term, text: `Add New Class: ${term}`, newTag: true };
                },
                templateSelection: (data) => data.newTag ? data.id : data.text,
                insertTag: (data, tag) => {
                    // Ensure new classes appear in the dropdown if not already present
                    if (!data.some(existingTag => existingTag.text === tag.text)) {
                        data.unshift(tag);
                    }
                }
            });

            $('#enrolledClasses').on('change', function () {
                let newSelectedClasses = $(this).val() || [];
            });

            $('#enrolledClasses').trigger('change');
        }
    });

</script>

