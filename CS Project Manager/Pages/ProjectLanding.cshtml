@page
@model CS_Project_Manager.Pages.ProjectLandingModel
@{
    ViewData["Title"] = "Project Landing Page";
}

<a href="/Dashboard" class="btn btn-primary" style="position: absolute; top: 10px; right: 10px;">Return to Dashboard</a>

<h2>Project - @Model.ProjectName</h2>

<hr>
<div style="display: flex; gap: 10px;">
    <form method="get" asp-page="/RequirementsStack">
        <input type="hidden" name="projectId" value="@Model.ProjectId.ToString()" />
        <button type="submit" class="btn btn-primary">Requirements Stack</button>
    </form>

    <form method="get" asp-page="/Brainstorm">
        <input type="hidden" name="projectId" value="@Model.ProjectId" />
        <button type="submit" class="btn btn-primary">Brainstorming</button>
    </form>

    <form method="get" asp-page="/Calendar">
        <input type="hidden" name="teamId" value="@Model.AssocTeamId" />
        <button type="submit" class="btn btn-primary">Calendar</button>
    </form>

    <form method="get" asp-page="/SprintBoard">
        <input type="hidden" name="projectId" value="@Model.ProjectId" />
        <button type="submit" class="btn btn-primary">Sprint Board</button>
    </form>

    <form method="get" asp-page="/DeleteProject">
        <input type="hidden" name="projectId" value="@Model.ProjectId" />
        <button type="submit" class="btn btn-danger">Delete Project</button>
    </form>
</div>

<!--import select2 functionality-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />

<script>
    $(document).ready(function () {
        $(".assignedUsers").select2({
            placeholder: "Select team members",
            allowClear: true
        });

        // Hide error messages on initial load for requirements with 0 progress
        $('.progress-input').each(function () {
            var progressValue = $(this).val();
            if (progressValue == 0) {
                $(this).siblings('.text-danger').hide();
            }
        });

        // Enable/disable progress input based on sprint number
        $('.sprint-input').on('input', function () {
            var index = $(this).data('index');
            var progressInput = $('.progress-input[data-index="' + index + '"]');
            var completeButton = progressInput.closest('td').next().find('.complete-button');
            if ($(this).val() === '') {
                // If sprint is cleared, disable progress input and reset to 0
                progressInput.prop('disabled', true);
                progressInput.val(0);
                progressInput.trigger('input');
                completeButton.prop('disabled', true);
                progressInput.siblings('.text-danger').show();
            } else {
                // If sprint is set, enable progress input
                progressInput.prop('disabled', false);
                completeButton.prop('disabled', false);
                progressInput.siblings('.text-danger').hide();
            }
        });

        // Update progress bar when progress input changes
        $('.progress-input').on('input', function () {
            var value = $(this).val();
            var progressBar = $(this).siblings('.progress').find('.progress-bar');
            progressBar.css('width', value + '%');
            progressBar.attr('aria-valuenow', value);
            var index = $(this).data('index');
            var sprintInput = $('.sprint-input[data-index="' + index + '"]');
            if (sprintInput.val() === '' && value > 0) {
                $(this).siblings('.text-danger').show();
            } else {
                $(this).siblings('.text-danger').hide();
            }
            // Get the complete button for this row
            var completeButton = $(this).closest('td').next().find('.complete-button');
            if (value == 100) {
                // If progress is 100% and not already marked complete, update button visual
                if (!completeButton.hasClass('btn-success')) {
                    completeButton.removeClass('btn-outline-success').addClass('btn-success');
                    completeButton.text('Completed');
                }
            } else {
                // If progress is less than 100% and marked as complete, update button visual
                if (completeButton.hasClass('btn-success')) {
                    completeButton.removeClass('btn-success').addClass('btn-outline-success');
                    completeButton.text('Complete');
                }
            }
        });

        // Show error only if there's no sprint number
        $('.progress-input').on('focus', function () {
            var index = $(this).data('index');
            var sprintInput = $('.sprint-input[data-index="' + index + '"]');
            if (sprintInput.val() === '') {
                $(this).siblings('.text-danger').show();
            }
        });
    });
</script>